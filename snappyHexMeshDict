/*--------------------------------*- C++ -*----------------------------------*\
  =========                 |
  \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox
   \\    /   O peration     | Website:  https://openfoam.org
    \\  /    A nd           | Version:  2312
     \\/     M anipulation  |
\*---------------------------------------------------------------------------*/
FoamFile
{
    format      ascii;
    class       dictionary;
    object      snappyHexMeshDict;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

/*
 * HIGH-RESOLUTION SNAPPYHEXMESH FOR BASEBALL WITH SEAM DETAIL
 * ===========================================================
 * 
 * Optimized for:
 * - Very fine surface resolution to capture seam geometry
 * - High wake refinement for Magnus effect
 * - Coarse background mesh to minimize computational cost
 * - Robust meshing for potentially problematic STL files
 */

// Which of the steps to run
castellatedMesh true;
snap            true;
addLayers       true;

// Geometry. Definition of all surfaces.
geometry
{
    baseball
    {
        type triSurfaceMesh;
        file "baseball.stl";
        name baseball;
        
        // Fix for multiple unconnected parts and inconsistent normals
        scale 1.0;          // Keep original size for now
        mergeTolerance 1e-5; // Merge nearby vertices
        
        // Try to handle the 161 disconnected parts
        regions
        {
            baseball
            {
                name baseball;
            }
        }
    }
    
    // Very tight refinement box around baseball for seam capture
    // Adjusted for 4.6cm baseball diameter
    nearFieldBox
    {
        type searchableBox;
        min (-0.04 -0.04 -0.04);  // Adjusted for actual baseball size
        max ( 0.04  0.04  0.04);
    }
    
    // Extended wake refinement - asymmetric for spinning ball
    wakeRefinementBox
    {
        type searchableBox;
        min (-0.03 -0.08 -0.08);  // Scaled for smaller baseball
        max ( 0.25  0.08  0.08);  // Proportional wake capture
    }
    
    // Intermediate transition box
    intermediateBox
    {
        type searchableBox;
        min (-0.06 -0.06 -0.06);  // Scaled appropriately
        max ( 0.12  0.06  0.06);
    }
}

// Settings for the castellatedMesh generation.
castellatedMeshControls
{
    // Very conservative limits for problematic geometry
    maxLocalCells 500000;    // Reduced to avoid memory issues with bad geometry
    maxGlobalCells 1000000;  // Conservative global limit
    minRefinementCells 0;    // Allow any refinement size
    maxLoadUnbalance 0.3;    // Allow more imbalance
    nCellsBetweenLevels 6;   // Larger buffer between levels
    
    // Very loose tolerance for bad geometry
    tolerance 1e-3;  // Much looser for problematic STL

    // Feature extraction disabled due to STL issues
    features
    (
        // Disabled due to disconnected parts
    );

    // Surface based refinement - conservative for bad STL
    refinementSurfaces
    {
        baseball
        {
            level (4 5);  // Much lower refinement to avoid issues
            
            patchInfo
            {
                type wall;
                inGroups (baseballGroup);
            }
        }
    }

    // Very permissive feature angle
    resolveFeatureAngle 45;  // More permissive

    // Conservative refinement regions
    refinementRegions
    {
        nearFieldBox
        {
            mode inside;
            levels ((1E15 3));  // Lower refinement
        }
        
        intermediateBox
        {
            mode inside;
            levels ((1E15 2));  // Even lower
        }
        
        wakeRefinementBox
        {
            mode inside; 
            levels ((1E15 3));  // Conservative wake refinement
        }
    }

    // Mesh selection point
    locationInMesh (0.1 0.0 0.0);

    // Very permissive settings for bad geometry
    allowFreeStandingZoneFaces true;
    handleSnapProblems true;
    useTopologicalSnapDetection false;
    checkGeometry false;             // Skip geometry checks
    mergeTolerance 1e-3;            // Loose merging
    
    // Additional robustness settings
    insidePoint (0.1 0.0 0.0);
    outsidePoints ();
}

// Enhanced snapping settings for high-resolution surfaces
snapControls
{
    nSmoothPatch 5;      // More smoothing for better surface conformity
    tolerance 1.0;       // Tighter tolerance
    nSolveIter 50;       // More iterations for complex geometry
    nRelaxIter 8;        // More relaxation steps
    nFeatureSnapIter 15; // More feature snapping iterations
    
    // Feature snapping settings
    implicitFeatureSnap false;
    explicitFeatureSnap true;
    multiRegionFeatureSnap false;
    
    // Enhanced controls for difficult geometries
    detectNearSurfaces true;  // Better surface detection
    strictRegionSnap true;    // Stricter snapping for quality
}

// Layer addition optimized for high surface resolution
addLayersControls
{
    relativeSizes true;

    // Boundary layer specification
    layers
    {
        baseball
        {
            nSurfaceLayers 10;  // More layers for better boundary layer resolution
        }
    }

    // Conservative expansion for high-resolution surface
    expansionRatio 1.15;  // Smaller ratio for smoother transition

    // Layer thickness - scale with surface resolution
    finalLayerThickness 0.1;   // Thinner final layer
    minThickness 0.01;         // Much thinner minimum
    
    // Conservative growth settings
    nGrow 2;  // Allow some growth for better convergence

    // Stricter angle controls for seam preservation
    featureAngle 45;        // More conservative for complex features
    slipFeatureAngle 20;    // Tighter slip control
    
    // Enhanced iteration controls
    nRelaxIter 8;           // More relaxation for complex geometry
    nSmoothSurfaceNormals 3; // More surface normal smoothing
    nSmoothNormals 5;       // More interior smoothing
    nSmoothThickness 15;    // More thickness smoothing
    
    // Quality controls for layers
    maxFaceThicknessRatio 0.4;    // Stricter face thickness control
    maxThicknessToMedialRatio 0.2; // Tighter medial ratio
    minMedialAxisAngle 90;
    
    // Buffer and iteration controls
    nBufferCellsNoExtrude 0;
    nLayerIter 75;  // More iterations for convergence
    
    // Additional controls for complex surfaces
    additionalReporting true;  // Better diagnostics
    mergeEdges true;          // Help with seam edges
}

// Strict quality controls for high-resolution mesh
meshQualityControls
{
    // Tightened quality metrics
    maxNonOrtho 60;           // Stricter orthogonality
    maxBoundarySkewness 15;   // Tighter boundary skewness
    maxInternalSkewness 3;    // Very tight internal skewness
    maxConcave 75;            // Conservative concavity
    minVol 1e-15;             // Smaller volume tolerance
    minTetQuality 1e-20;      // Very strict tet quality
    minArea -1;
    minTwist 0.01;            // Tighter twist control
    minDeterminant 0.005;     // Higher determinant requirement
    minFaceWeight 0.05;       // Conservative face weight
    minVolRatio 0.02;         // Higher volume ratio
    minTriangleTwist -1;
    
    // Smoothing controls
    nSmoothScale 6;           // More smoothing passes
    errorReduction 0.8;       // More aggressive error reduction
    
    // Relaxed settings for difficult areas
    relaxed
    {
        maxNonOrtho 70;
        maxBoundarySkewness 25;
        maxInternalSkewness 6;
        minTetQuality 1e-25;
    }
}

// Debug and merge settings
debug 0;
mergeTolerance 1e-6;  // Very tight merging for feature preservation

// ************************************************************************* //
